// @ts-nocheck
import{auth,db}from"./firebase-config.js";import{createUserWithEmailAndPassword,updateProfile}from"https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";import{doc,setDoc,serverTimestamp}from"https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";function setupCustomAlert(){const e=document.getElementById("alertModal"),t=document.getElementById("alertText"),a=document.getElementById("alertClose");function o(){e&&(e.style.display="none")}return a&&a.addEventListener("click",o),e&&e.addEventListener("click",(t=>{t.target===e&&o()})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&o()})),function(a){e&&t?(t.textContent=a,e.style.display="flex"):window.alert(a)}}const showAlert=setupCustomAlert();document.addEventListener("DOMContentLoaded",(()=>{const e=document.querySelector("#fullname, #name, #nama")||document.querySelector("input[name='fullname'], input[name='name']"),t=document.querySelector("#email")||document.querySelector("input[type='email']"),a=document.querySelector("#phone, #telp, #nohp")||document.querySelector("input[type='tel']"),o=document.querySelector("#password")||document.querySelector("input[type='password']"),r=document.querySelector("#confirm-password, #password2, #confirmpassword"),n=document.querySelector("#createAccountBtn, #create-account-btn, #signupBtn, #signUpBtn, .create-btn, .signup-btn")||document.querySelector("button[type='submit']");console.log("cek elemen signup:",{nameEl:e,emailEl:t,phoneEl:a,passEl:o,confirmEl:r,submitBtn:n}),n?(document.querySelectorAll(".toggle").forEach((e=>{e.addEventListener("click",(()=>{const t=e.previousElementSibling;if(!t)return;const a="password"===t.type;t.type=a?"text":"password",e.textContent=a?"ðŸ™ˆ":"ðŸ‘ï¸"}))})),n.addEventListener("click",(async l=>{if(l.preventDefault(),n.disabled)return;n.disabled=!0;const s=(e?.value||"").trim(),i=(t?.value||"").trim(),c=(a?.value||"").trim(),d=o?.value||"",u=r?.value||"";if(!(s&&i&&c&&d&&u))return showAlert("Semua kolom wajib diisi ya ðŸ™‚"),void(n.disabled=!1);if(!function(e){return/[a-z]/.test(e)&&/[A-Z]/.test(e)&&/\d/.test(e)&&/[^A-Za-z0-9]/.test(e)&&e.length>=8}(d))return showAlert("Password harus minimal 8 karakter, ada huruf besar, huruf kecil, angka, dan simbol."),void(n.disabled=!1);if(d!==u)return showAlert("Password dan konfirmasinya tidak sama."),void(n.disabled=!1);try{const e=(await createUserWithEmailAndPassword(auth,i,d)).user;try{await updateProfile(e,{displayName:s})}catch(e){console.warn("updateProfile warning:",e)}const t="byverent@gmail.com",a=i.toLowerCase()===t.toLowerCase()?"admin":"user";try{await setDoc(doc(db,"users",e.uid),{name:s,email:i,phone:c,role:a,memberSince:(new Date).getFullYear(),createdAt:serverTimestamp()}),console.log("User doc written to Firestore for uid:",e.uid)}catch(e){console.warn("Warning: failed to write user doc to Firestore",e)}localStorage.setItem("maziUID",e.uid),localStorage.setItem("maziRole",a),localStorage.setItem("maziEmail",i),localStorage.setItem("maziName",s),localStorage.setItem("maziPhone",c);const o=s.split(/\s+/),r=o[0]||"",n={firstName:r,lastName:o.slice(1).join(" "),email:i,phone:c,memberSince:(new Date).getFullYear()};localStorage.setItem("profile",JSON.stringify(n)),"function"==typeof window.flushOrderQueue?window.flushOrderQueue().then((()=>console.log("flushOrderQueue completed after signup"))).catch((e=>console.warn("flush after signup failed",e))):console.log("flushOrderQueue not present on this page");const l=new URLSearchParams(window.location.search).get("from");if("bag"===l||"checkout"===l){try{const e=JSON.parse(localStorage.getItem("checkoutDraft_cart")||"null");e&&(localStorage.setItem("cart",JSON.stringify(e)),localStorage.removeItem("checkoutDraft_cart"))}catch(e){console.warn("restore draft failed",e)}return void(window.location.href="bag"===l?"bagfr.html":"cekout.html")}showAlert("Akun berhasil dibuat! ðŸŽ‰");const u=document.getElementById("alertModal"),m=document.getElementById("alertClose");if(m&&u){const e=()=>{u.style.display="none",m.removeEventListener("click",e),window.location.href="alamat.html?from=signup"};m.addEventListener("click",e)}else window.location.href="alamat.html?from=signup"}catch(e){console.error("Error Firebase:",e);let t="Terjadi kesalahan saat mendaftar.";"auth/email-already-in-use"===e.code?t="Email ini sudah terdaftar. Silakan Sign In saja ya ðŸ™‚":"auth/invalid-email"===e.code?t="Format email tidak valid.":"auth/weak-password"===e.code&&(t="Password terlalu lemah."),showAlert(t)}finally{n.disabled=!1}}))):console.error("Tombol signup tidak ditemukan. Tambah id/create-btn di HTML.")}));