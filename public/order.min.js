// @ts-nocheck
import{db,auth}from"./firebase-config.js";import{onAuthStateChanged}from"https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";import{getDocs,collection,query,where}from"https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";!function(){"use strict";function t(t){return"Rp "+new Intl.NumberFormat("id-ID").format(Number(t||0))}function e(t){try{return JSON.parse(localStorage.getItem(t)||"[]")}catch(t){return[]}}function r(t){return String(t||"").replace(/[&<>"']/g,(t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[t])))}function i(t,e=!0){try{if(!t&&e)return new Date;if(!t)return null;if(t&&"function"==typeof t.toDate)return t.toDate();const r=new Date(t);return isNaN(r.getTime())?e?new Date:null:r}catch(t){return e?new Date:null}}function n(){return e("orders")}function a(t){try{localStorage.setItem("orders",JSON.stringify(t||[]))}catch(t){console.error("Failed to save orders",t)}}function s(t){const e=Array.isArray(t)?t:[],{uid:r,email:i}=auth&&auth.currentUser?{uid:String(auth.currentUser.uid||"").trim(),email:String(auth.currentUser.email||"").trim().toLowerCase()}:{uid:(localStorage.getItem("maziUID")||"").trim(),email:(localStorage.getItem("maziEmail")||"").trim().toLowerCase()};return r||i?e.filter((t=>{if(!t)return!1;const e=String(t.userId||"").trim(),n=String(t.userEmail||"").trim().toLowerCase();return!(!r||!e||r!==e)||!(!i||!n||i!==n)})):e.filter((t=>!t||!t.userId&&!t.userEmail))}function d(t,e){const a="history"===(e&&e.context||""),d=t.items&&t.items[0],c=Math.max(0,(t.items||[]).length-1),l=d?function(t){const e=String(t?.id||"").toLowerCase(),r=String(t?.title||"").toLowerCase();return e.startsWith("dsri")||e.startsWith("dessert")||r.includes("dessert")?"Desserts":e.startsWith("drsi")||e.startsWith("drink")||r.includes("latte")||r.includes("drink")?"Drinks":"Products"}(d):"Products",u=d&&d.image?'<img src="'+r(d.image)+'" alt="'+r(d.title)+'" style="width:68px;height:68px;object-fit:cover;border-radius:8px">':'<div class="thumb"></div>',m=t.status||"active",g=i(t.createdAt),h=g?g.toLocaleString("id-ID"):"";let f="";if(a&&"cancelled"===String(m).toLowerCase())f='  <div class="order-actions">    <button class="btn-outline reorder-btn" data-order-id="'+r(t.id)+'">Reorder</button>    <button class="btn-light view-details" data-order-id="'+r(t.id)+'">View Details</button>  </div>';else{const e=a?"Reorder":"View Details",i=a?"reorder-btn":"view-details";f='  <div class="order-actions">    <button class="btn-outline track-btn" data-order-id="'+r(t.id)+'">Track Order</button>    <button class="btn-light '+i+'" data-order-id="'+r(t.id)+'">'+e+"</button>  </div>"}const v=document.createElement("article");return v.className="order-card",v.innerHTML='<div class="thumb">'+u+'</div><div class="order-info">  <div class="order-top">    <h3 class="product-title">'+r(d?d.title:"No title")+'</h3>    <span class="more">'+(c>0?"+"+c+" More":"")+'</span>  </div>  <p class="brand">'+r(l)+'</p>  <div class="status-row">    <span class="status">Status : <strong>'+r(m)+'</strong></span>    <span class="eta">Created : <em>'+r(h)+"</em></span>  </div>"+f+"</div>",v.querySelectorAll(".view-details").forEach((t=>{t.addEventListener("click",(function(){o(this.dataset.orderId)}))})),v.querySelectorAll(".reorder-btn").forEach((t=>{t.addEventListener("click",(function(){const t=this.dataset.orderId;t&&function(t){const e=n()||[],r=s(e).find((e=>String(e.id)===String(t)));if(!r)return void alert("Order tidak ditemukan.");let i=function(){try{return JSON.parse(localStorage.getItem("cart")||"[]")}catch(t){return[]}}()||[];(r.items||[]).forEach(((t,e)=>{if(!t)return;const n=Number(t.qty||1),a=Number(t.unitPrice||t.price||0),s=Number(t.subtotal||a*n),d={id:t.id||`reorder-${r.id}-${e}`,title:t.title||"",unitPrice:a,qty:n,subtotal:s,image:t.image||t.images&&t.images[0]||"assets/placeholder.png",addons:t.addons||[],source:"reorder"};i.push(d)})),function(t){try{localStorage.setItem("cart",JSON.stringify(t||[]))}catch(t){console.error("Failed to save bag items",t)}}(i),alert("Barang dari order ini sudah dimasukkan ke Bag ‚úî"),window.location.href="bagfr.html"}(t)}))})),v.querySelectorAll(".track-btn").forEach((t=>{t.addEventListener("click",(function(){const t=this.dataset.orderId;t&&(window.location.href="ditel.html?id="+encodeURIComponent(t))}))})),v}function o(a){let d=(s(n())||[]).find((t=>String(t.id)===String(a)));d=function(t){if(!t)return null;const e=s([t]);return e.length?e[0]:null}(d);const o=["tab-active","tab-schedule","tab-scheduled","tab-history"];let c=null;for(const t of o){const e=document.getElementById(t);if(!e)continue;const r="none"===e.style.display,i=e.classList.contains("hidden");if(!r&&!i){c=e;break}}if(c||(c=document.getElementById("tab-history")||document.getElementById("tab-active")),!c)return;if(c.innerHTML="",!d)return void(c.innerHTML='<div style="padding:12px;color:#c33">Order tidak ditemukan.</div>');const u=document.createElement("h2");u.textContent="Order Details",c.appendChild(u);const m=document.createElement("div");if(m.style.marginTop="12px",(d.items||[]).forEach((e=>{const i=document.createElement("div");i.style.padding="10px 0",i.innerHTML='<div style="display:flex;gap:12px;align-items:center">  <div style="width:56px;height:56px;border-radius:8px;overflow:hidden;background:#f5f5f7;flex:0 0 56px">'+(e.image?'<img src="'+r(e.image)+'" style="width:100%;height:100%;object-fit:cover">':"")+'  </div>  <div style="flex:1">    <div style="font-weight:700">'+r(e.title)+"</div>"+(e.addons&&e.addons.length?'<div style="color:#666;margin-top:6px">'+e.addons.map((t=>r(t.label))).join(", ")+"</div>":"")+'    <div style="color:#666;margin-top:6px">'+(e.qty||0)+" √ó "+t(e.unitPrice)+" = "+t(e.subtotal)+"</div>  </div></div>",m.appendChild(i)})),c.appendChild(m),d.isGift&&d.gift){const t=document.createElement("div");t.className="order-gift-block",t.style.marginTop="12px",t.style.padding="12px",t.style.borderRadius="10px",t.style.background="#fff6fb";const e="surprise"===String(d.gift.revealMode||"reveal")?"Keep it a surprise":"Reveal it now";let n="";if(d.scheduledAt)try{n="<div><strong>Schedule:</strong> "+r(i(d.scheduledAt).toLocaleString("id-ID"))+"</div>"}catch(t){}const a=d.gift.message?"<div><strong>Message:</strong> "+r(d.gift.message)+"</div>":"",s=d.gift.fromName?"<div><strong>From:</strong> "+r(d.gift.fromName)+"</div>":"",o=d.gift.theme?"<div><strong>Card theme:</strong> "+r(d.gift.theme)+"</div>":"";t.innerHTML='<div style="font-weight:600;margin-bottom:4px">üéÅ Gift details</div>'+a+s+"<div><strong>Reveal:</strong> "+r(e)+"</div>"+o+n,c.appendChild(t)}const g=d.meta&&"string"==typeof d.meta.recipient?d.meta.recipient.trim():"";if(g){const t=document.createElement("div");t.className="order-address-block";const e=r(g).replace(/\n/g,"<br>");t.innerHTML=`<div class="order-address-head"><span class="title">Recipient</span></div><div class="order-address-body"><div class="line-address">${e}</div></div>`,c.appendChild(t)}else{const t=e("savedAddresses_v1");let i=null;if(Array.isArray(t)&&t.length&&(i=t.find((t=>t&&t.isDefault))||t[0]),i){const t=document.createElement("div");t.className="order-address-block";const e=r(i.label||""),n=r(i.name||""),a=r(i.phone||""),s=r(i.address||"").replace(/\n/g,"<br>"),d=`${e||""}${e&&n?" - ":""}${n||""}`;t.innerHTML=`<div class="order-address-head"><span class="title">Address</span><a href="drafamt.html" class="edit-link small">Edit</a></div><div class="order-address-body"><div class="line-combined">${d}</div>${a?`<div class="line-phone">${a}</div>`:""}<div class="line-address">${s}</div></div>`,c.appendChild(t)}}const h=(d.paymentStatus||"pending").toLowerCase(),f=(d.status||"").toLowerCase(),v="paid"===h,p="rejected"===h||"cancelled"===f,b=document.createElement("div");let y="pending",w="";v?(y="paid",w="<div>Status pesanan: <strong>Pesanan "+r(d.id||"")+' sudah dibayar.</strong></div><div class="status">Pembayaran sudah diterima admin ‚úÖ</div><div class="track-hint">Anda dapat men-track order Anda dari halaman Orders / Active.</div>'):p?w='<div style="font-weight:600">‚õî Orderan ini dicancel oleh admin</div><div class="status">Status pembayaran: <strong style="color:#c00">Ditolak admin</strong></div><div class="track-hint" style="color:#c00">Silakan hubungi admin jika ada kesalahan.</div>':(y="pending",w='<div>Segera melakukan pembayaran melalui WhatsApp kepada toko agar orderan Anda dapat di-ACC.</div><div class="status">Status pembayaran: <strong>Pembayaran belum diterima admin</strong></div>'),p||(b.className="order-payment-note "+y,b.innerHTML=w),c.appendChild(b);const S=document.createElement("div");S.style.marginTop="12px",S.style.fontWeight="700",S.textContent="Total: "+t(d.total),c.appendChild(S);const k=document.createElement("div");k.style.marginTop="12px",k.innerHTML='<button class="btn-light" id="back-to-summary">Back to summary</button>',c.appendChild(k);const L=k.querySelector("#back-to-summary");L&&L.addEventListener("click",(function(){l()}))}function c(){const t=document.getElementById("notif-badge");if(!t)return;const r=e("notifications_v1");Array.isArray(r)&&r.some((t=>!t.isRead))?t.classList.add("show"):t.classList.remove("show")}function l(){!function(){const t=document.getElementById("tab-active");if(!t)return;t.innerHTML="";const e=s(n()||[]);let r=e.filter((t=>"active"===String(t.status||"").toLowerCase()));r.length||(r=e.filter((t=>!t.status))),r.length?r.forEach((e=>t.appendChild(d(e,{context:"active"})))):t.innerHTML='<div style="padding:16px;color:#666">Tidak ada pesanan aktif saat ini.</div>'}(),function(){const t=document.getElementById("tab-schedule")||document.getElementById("tab-scheduled");if(!t)return;t.innerHTML="";const e=(s(n()||[])||[]).filter((t=>{const e=String(t.status||"").toLowerCase();return!["delivered","completed","cancelled"].includes(e)&&("scheduled"===e||t.scheduledAt)}));e.length?e.forEach((e=>t.appendChild(d(e,{context:"scheduled"})))):t.innerHTML='<div style="padding:16px;color:#666">No scheduled orders.</div>'}(),function(){const t=document.getElementById("tab-history");if(!t)return;t.innerHTML="";const e=s(n()||[]).filter((t=>{const e=String(t.status||"").toLowerCase();return["delivered","completed","cancelled"].includes(e)}));e.length?e.forEach((e=>t.appendChild(d(e,{context:"history"})))):t.innerHTML='<div style="padding:16px;color:#666">History kosong.</div>'}()}onAuthStateChanged(auth,(async t=>{try{if(a([]),l(),c(),!t)return void console.log("No user logged in ‚Äî orders cleared.");await async function(t){try{if(!t)return a([]),[];const e=collection(db,"orders"),r=query(e,where("userId","==",t.uid));let n=(await getDocs(r)).docs.map((t=>{const e=t.data()||{};return{id:t.id,...e}}));n.sort(((t,e)=>{const r=i(t.createdAt,!1),n=i(e.createdAt,!1),a=r?r.getTime():0;return(n?n.getTime():0)-a}));const s=String(t.uid||"").trim(),d=String(t.email||"").trim().toLowerCase();return n=n.filter((t=>{const e=String(t.userId||"").trim(),r=String(t.userEmail||"").trim().toLowerCase();return!(!s||!e||s!==e)||!(!d||!r||d!==r)})),a(n),console.log("Orders fetched for user",s,"count =",n.length),n}catch(t){return console.warn("Failed to fetch orders from Firestore, using local cache only:",t),s(n()||[])}}(t),l()}catch(t){console.error("Auth-state handling error",t)}})),document.addEventListener("DOMContentLoaded",(function(){try{l(),document.querySelectorAll("[data-order-tab],[data-tab]").forEach((t=>{t.addEventListener("click",(function(){const t=this.dataset.orderTab||this.dataset.tab;if(!t)return;const e={active:"tab-active",scheduled:"tab-scheduled",schedule:"tab-schedule",history:"tab-history"}[t]||t;["tab-active","tab-scheduled","tab-schedule","tab-history"].forEach((t=>{const r=document.getElementById(t);if(!r)return;const i=t===e;r.style.display=i?"":"none",r.classList.toggle("hidden",!i)})),document.querySelectorAll("[data-order-tab],[data-tab]").forEach((e=>{const r=(e.dataset.orderTab||e.dataset.tab)===t;e.classList.toggle("tab-active",r),e.setAttribute("aria-selected",r?"true":"false")}))}))})),c(),window.addEventListener("storage",(function(t){"notifications_v1"!==t.key&&"orders"!==t.key||(l(),c())}))}catch(t){console.error("order init error",t)}})),window.renderAllOrders=l,window.renderOrderDetails=o,window.updateNotifBadge=c}();