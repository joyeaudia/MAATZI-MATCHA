// @ts-nocheck
import{db,auth}from"./firebase-config.js";import{collection,query,where,getDocs,updateDoc,doc}from"https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";import{onAuthStateChanged}from"https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";const ADMIN_EMAIL="byverent@gmail.com";!function(){"use strict";function t(t){try{return JSON.parse(localStorage.getItem(t)||"[]")}catch(t){return[]}}function e(t){try{localStorage.setItem("orders",JSON.stringify(t||[]))}catch(t){console.error("Failed to save orders",t)}}function a(t){return"Rp "+new Intl.NumberFormat("id-ID").format(Number(t||0))}function i(t){return String(t||"").replace(/[&<>"']/g,(t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[t])))}function n(){return t("orders")}let s="all";function d(t,e){let a;try{a=JSON.parse(localStorage.getItem("notifications_v1")||"[]")}catch(t){a=[]}const i=new Date;let n="",s="",d="";"approved"===e?(n="Payment Confirmed",d="üí∏",s="Order "+(t.id||"")+" telah dikonfirmasi dan pembayaran sudah diterima admin."):"rejected"===e&&(n="Order Rejected",d="‚õî",s="Order "+(t.id||"")+" telah ditolak / dibatalkan oleh admin.");const r={id:"adm-"+e+"-"+(t.id||"")+"-"+i.getTime(),title:n,message:s,emoji:d,time:"Just now",isRead:!1};a.unshift(r);try{localStorage.setItem("notifications_v1",JSON.stringify(a))}catch(t){console.error("Failed to save notifications",t)}}async function r(t){try{if(!t||!t.id)return;let e=t.firestoreId||null;if(!e){const a=collection(db,"orders"),i=query(a,where("id","==",t.id)),n=await getDocs(i);if(n.empty)return void console.warn("Tidak menemukan dokumen Firestore untuk order",t.id);e=n.docs[0].id,t.firestoreId=e}const a=doc(db,"orders",e),i={};void 0!==t.status&&(i.status=t.status),void 0!==t.paymentStatus&&(i.paymentStatus=t.paymentStatus),await updateDoc(a,i),console.log("Order updated in Firestore:",t.id,i)}catch(t){console.error("Gagal sync order ke Firestore:",t)}}function o(){const l=document.getElementById("order-list");if(!l)return;l.innerHTML="";let c=n()||[];c=c.filter((t=>"cancelled"!==String(t.status||"").toLowerCase())),"history"===s?c=c.filter((t=>"completed"===String(t.status||"").toLowerCase())):(c=c.filter((t=>"completed"!==String(t.status||"").toLowerCase())),"gift"===s&&(c=c.filter((t=>!!t.isGift&&!!t.gift)))),c.length?c.forEach((s=>{l.appendChild(function(s){const l=document.createElement("article");l.className="admin-order-card";const c=new Date(s.createdAt||Date.now()).toLocaleString(),m=(s.status||"active").toLowerCase(),u=(s.paymentStatus||"pending").toLowerCase();"completed"===m?l.classList.add("is-completed"):"paid"===u&&l.classList.add("is-paid");const p=!!s.isGift&&!!s.gift;p&&l.classList.add("gift");let v="";if(s.scheduledAt)try{v=new Date(s.scheduledAt).toLocaleString("id-ID")}catch(t){}const f=s.items&&s.items[0]?s.items[0]:null,g=f?f.title||f.name||"":"(no items)",y=s.meta&&"string"==typeof s.meta.recipient?s.meta.recipient.trim():"",b=t("savedAddresses_v1");let h=null;Array.isArray(b)&&b.length&&(h=b.find((t=>t&&t.isDefault))||b[0]);let S="";if(y){S=`\n        <div class="admin-address">\n          <div class="admin-address-title">Recipient</div>\n          <div class="admin-address-main">\n            <div>${i(y).replace(/\n/g,"<br>")}</div>\n          </div>\n        </div>\n      `}else if(h){const t=i(h.label||""),e=i(h.name||""),a=i(h.phone||"");S=`\n        <div class="admin-address">\n          <div class="admin-address-title">Address</div>\n          <div class="admin-address-main">\n            <div>${`${t||""}${t&&e?" - ":""}${e||""}`}</div>\n            ${a?`<div>${a}</div>`:""}\n            <div>${i(h.address||"").replace(/\n/g,"<br>")}</div>\n          </div>\n        </div>\n      `}let w="";if(p){const t="surprise"===String(s.gift.revealMode||"reveal")?"Keep it a surprise":"Reveal it now";w=`\n        <div class="admin-gift-block">\n          <div class="admin-gift-title">üéÅ Gift order</div>\n          ${s.gift.message?`<div class="admin-gift-line"><strong>Message:</strong> ${i(s.gift.message)}</div>`:""}\n          ${s.gift.fromName?`<div class="admin-gift-line"><strong>From:</strong> ${i(s.gift.fromName)}</div>`:""}\n          <div class="admin-gift-line"><strong>Reveal:</strong> ${i(t)}</div>\n          ${v?`<div class="admin-gift-line"><strong>Schedule:</strong> ${i(v)}</div>`:""}\n        </div>\n      `}let L="";(s.items||[]).forEach((t=>{if(!t)return;const e=i(t.title||t.name||""),n=t.addons&&t.addons.length?'<div class="admin-item-addons">'+t.addons.map((t=>i(t.label||""))).join(", ")+"</div>":"",s=Number(t.qty||0),d=Number(t.unitPrice||t.price||0),r=Number(t.subtotal||d*s),o=s+" √ó "+a(d)+" = "+a(r);L+=`\n        <div class="admin-item-row">\n          <div class="admin-item-main">\n            <div class="admin-item-title">${e}</div>\n            ${n}\n            <div class="admin-item-price">${i(o)}</div>\n          </div>\n        </div>\n      `}));const $="paid"===u?"badge-payment paid":"rejected"===u?"badge-payment rejected":"badge-payment";l.innerHTML=`\n      <div class="admin-order-header">\n        <div>\n          <div class="admin-order-id">Order ID: ${i(s.id||"(no id)")}</div>\n          <div class="admin-order-created">${i(c)}</div>\n        </div>\n        <div class="admin-order-total">\n          <span class="admin-total-label">Total</span>\n          <span class="admin-total-value">${a(s.total)}</span>\n        </div>\n      </div>\n\n      <div class="admin-status-row">\n        <span class="badge badge-status">${i(m)}</span>\n        <span class="badge ${$}">${i(u)}</span>\n      </div>\n\n      <div class="admin-summary-row">\n        <span class="summary-chip">${p?"üéÅ Gift":"Order"}</span>\n        <span class="summary-main">${i(g)}</span>\n        ${v&&p?`<span class="summary-schedule"> ¬∑ ${i(v)}</span>`:""}\n        <button type="button" class="btn-toggle-detail" aria-expanded="false">\n          Detail\n        </button>\n      </div>\n\n      <div class="admin-details">\n        ${w}\n        <div class="admin-items">\n          ${L}\n        </div>\n        ${S}\n        <div class="admin-actions">\n          <button class="btn btn-approve" data-id="${i(s.id)}">ACC (sudah dibayar)</button>\n          <button class="btn btn-reject" data-id="${i(s.id)}">Tolak order</button>\n          <button class="btn btn-delivered" data-id="${i(s.id)}">Mark as delivered</button>\n        </div>\n      </div>\n    `;const E=l.querySelector(".btn-approve"),D=l.querySelector(".btn-reject"),A=l.querySelector(".btn-delivered"),I=l.querySelector(".admin-details"),C=l.querySelector(".btn-toggle-detail");I&&(window.innerWidth<600?(I.classList.add("collapsed"),C&&(C.setAttribute("aria-expanded","false"),C.textContent="Detail")):(I.classList.remove("collapsed"),C&&(C.setAttribute("aria-expanded","true"),C.textContent="Sembunyikan")));C&&I&&C.addEventListener("click",(function(t){t.stopPropagation();const e=I.classList.toggle("collapsed");this.setAttribute("aria-expanded",String(!e)),this.textContent=e?"Detail":"Sembunyikan"}));"completed"===m||"cancelled"===m?(E&&(E.style.display="none"),D&&(D.style.display="none"),A&&(A.style.display="none")):"paid"===u?(E&&(E.style.display="none"),D&&(D.style.display="none")):A&&(A.style.display="none");E&&E.addEventListener("click",(async function(t){t.stopPropagation();const a=this.dataset.id,i=n(),s=i.findIndex((t=>String(t.id)===String(a)));if(-1!==s){i[s].paymentStatus="paid",i[s].status||(i[s].status="active"),d(i[s],"approved"),e(i),o();try{await r(i[s])}catch(t){console.error("Error sync saat ACC:",t)}alert("Order di-set sebagai SUDAH DIBAYAR.")}}));D&&D.addEventListener("click",(async function(t){t.stopPropagation();const a=this.dataset.id,i=n(),s=i.findIndex((t=>String(t.id)===String(a)));if(-1!==s){i[s].paymentStatus="rejected",i[s].status="cancelled",d(i[s],"rejected"),e(i),o();try{await r(i[s])}catch(t){console.error("Error sync saat REJECT:",t)}alert("Order telah DITOLAK / dibatalkan oleh admin.")}}));A&&A.addEventListener("click",(async function(t){t.stopPropagation();const a=this.dataset.id,i=n(),s=i.findIndex((t=>String(t.id)===String(a)));if(-1!==s){if("paid"!==String(i[s].paymentStatus||"").toLowerCase())return void alert("Order harus sudah dibayar sebelum ditandai sebagai delivered.");i[s].status="completed",e(i),o();try{await r(i[s])}catch(t){console.error("Error sync saat DELIVERED:",t)}alert("Order ditandai sebagai DELIVERED dan pindah ke History.")}}));return l.addEventListener("click",(function(t){if(t.target.closest(".admin-actions")||t.target.closest(".btn-toggle-detail"))return;if("paid"!==u)return;const e=s.id||"";e&&(window.location.href="diteladm.html?id="+encodeURIComponent(e))})),l}(s))})):l.innerHTML='<div style="color:#777;font-size:13px;">Belum ada order.</div>'}document.addEventListener("DOMContentLoaded",(function(){onAuthStateChanged(auth,(t=>{if(!t)return void(window.location.href="singin.html?from=admin");if(!((t.email||"").toLowerCase()===ADMIN_EMAIL.toLowerCase()))return void(window.location.href="index.html");console.log("Admin verified");const e=document.querySelectorAll(".admin-pill");e.length&&e.forEach((t=>{t.addEventListener("click",(()=>{const a=t.dataset.filter||"all";s=a,e.forEach((t=>t.classList.remove("is-active"))),t.classList.add("is-active"),o()}))})),o()}))}))}();