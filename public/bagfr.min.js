// @ts-nocheck
import{db,auth}from"./firebase-config.js";import{onAuthStateChanged,signInAnonymously}from"https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";import{collection,addDoc,serverTimestamp}from"https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";(()=>{"use strict";const t=t=>"Rp "+(t=Math.round(Number(t)||0)).toString().replace(/\B(?=(\d{3})+(?!\d))/g,"."),e=t=>String(t||"").replace(/[&<>"']/g,(t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[t])));function a(){try{return JSON.parse(localStorage.getItem("cart")||"[]")}catch(t){return[]}}function r(t){localStorage.setItem("cart",JSON.stringify(t||[]))}function i(){const r=a(),i=document.getElementById("bag-items")||document.querySelector(".cart-list")||document.querySelector(".bag-items");if(!i)return;if(i.innerHTML="",!r.length)return i.innerHTML='<div class="empty-bag"><img src="acs/bag1.png" alt="Keranjang kosong"></div>',void n();let s=0;r.forEach(((a,r)=>{const n=Number(a.unitPrice||a.price||0),o=Number(a.qty||1),l=Number(a.subtotal||n*o||0);s+=l;const c=a.addons&&a.addons.length?a.addons.map((a=>{const r=String(a.label||"").trim(),i=/\(\s*\+\s*\d+|Rp\b|K\)/i.test(r),n=e(r);return i?`<div class="addon">${n}</div>`:`<div class="addon">${n}${a.price?` (+${t(a.price)})`:""}</div>`})).join(""):"",d=`\n        <article class="cart-item" data-idx="${r}" data-price="${n}">\n          <div class="thumb">\n            <img src="${e(a.image||a.images&&a.images[0]||"assets/placeholder.png")}" alt="${e(a.title||"Product")}" onerror="this.onerror=null;this.src='assets/placeholder.png'">\n          </div>\n          <div class="item-body">\n            <div class="item-head">\n              <div>\n                <div class="item-title">${e(a.title||"Untitled")}</div>\n                <div class="item-meta">${c}</div>\n              </div>\n              <button class="remove" title="Hapus item" aria-label="Hapus item" data-idx="${r}">\n                <img src="acs/smph.png" alt="Hapus">\n              </button>\n            </div>\n            <div class="item-controls">\n              <div class="qty-control">\n                <button class="qty-btn qty-decr" aria-label="Kurangi">-</button>\n                <span class="qty">${o}</span>\n                <button class="qty-btn qty-incr" aria-label="Tambah">+</button>\n              </div>\n              <div class="right-col">\n                <div class="item-sub-value">${t(l)}</div>\n              </div>\n            </div>\n          </div>\n        </article>\n      `,u=document.createElement("div");u.innerHTML=d.trim(),i.appendChild(u.firstElementChild)})),n(s)}function n(e){let r=Number(e||0);if(!e){r=a().reduce(((t,e)=>t+(Number(e.subtotal)||Number(e.unitPrice||e.price||0)*Number(e.qty||1))),0)}const i=document.querySelector(".summary-value")||document.getElementById("bag-total")||document.querySelector(".bag-total");i&&(i.textContent=t(r))}function s(){try{return JSON.parse(localStorage.getItem("likes")||"[]")}catch(t){return[]}}function o(){const t=s(),a=document.querySelector(".liked-row")||document.getElementById("liked-row");a&&(a.innerHTML="",t.length?t.forEach((t=>{const r=String(t.id||""),i=String(t.title||""),n=String(t.image||"assets/placeholder.png"),s=Number(t.price||0),o=s?"Rp "+new Intl.NumberFormat("id-ID").format(s):"",l=document.createElement("article");l.className="like-card",l.setAttribute("role","listitem"),l.setAttribute("data-id",r),l.setAttribute("data-source",t.source||(r.includes("dsri-")?"dsri":r.includes("drsi-")?"drsi":"")),l.innerHTML=`\n        <div class="like-thumb">\n          <img src="${e(n)}" alt="${e(i)}" onerror="this.onerror=null;this.src='assets/placeholder.png'">\n        </div>\n        <div class="like-body">\n          <div class="like-title">${e(i)}</div>\n        </div>\n        <div class="like-footer">\n          ${o?`<div class="like-price footer-price">${e(o)}</div>`:""}\n          <button class="like-heart" aria-label="Unlike" title="Unlike" data-id="${e(r)}" aria-pressed="false">‚ù§</button>\n        </div>\n      `,a.appendChild(l)})):a.innerHTML='<div style="color:#888;padding:12px">You have no liked items yet.</div>')}function l(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";let e="";for(let a=0;a<5;a++)e+=t[Math.floor(52*Math.random())];let a="";for(let t=0;t<4;t++)a+=Math.floor(10*Math.random());return e+a}function c(){try{return JSON.parse(localStorage.getItem("cart")||"[]")}catch(t){return[]}}async function d(){try{const t="order_sync_queue",e=localStorage.getItem(t)||"[]",a=JSON.parse(e);if(!Array.isArray(a)||0===a.length)return;const r=auth.currentUser;if(!r)return void console.warn("Bagfr flush: no authenticated user ‚Äî skip flush until login.");console.log("Bagfr flush: Flushing order sync queue, items:",a.length);for(let t=0;t<a.length;t++){const e=a[t];try{const i={userId:r.uid,userEmail:r.email||localStorage.getItem("maziEmail")||"",userName:localStorage.getItem("maziName")||"",id:e.id,createdAt:serverTimestamp(),status:e.status||"active",paymentStatus:e.paymentStatus||"pending",total:e.total,items:e.items||[],meta:e.meta||{},isGift:e.isGift||!1,gift:e.gift||null},n=await addDoc(collection(db,"orders"),i);console.log("Bagfr flush: Flushed order -> firestore id:",n.id,"local order id:",e.id),a.splice(t,1),t--}catch(t){console.warn("Bagfr flush: failed to push one order, will retry later",t);break}}localStorage.setItem(t,JSON.stringify(a))}catch(t){console.error("Bagfr flushOrderQueue failed",t)}}document.addEventListener("click",(function(t){const e=t.target.closest(".cart-item");if(e){const n=Number(e.dataset.idx);let s=a();if(t.target.closest(".qty-incr"))return s[n].qty=Number(s[n].qty||1)+1,s[n].subtotal=Number(s[n].unitPrice||s[n].price||0)*s[n].qty,r(s),void i();if(t.target.closest(".qty-decr"))return s[n].qty=Math.max(1,Number(s[n].qty||1)-1),s[n].subtotal=Number(s[n].unitPrice||s[n].price||0)*s[n].qty,r(s),void i();if(t.target.closest(".remove"))return s.splice(n,1),r(s),void i()}const n=t.target.closest(".like-heart");if(n){n.setAttribute("aria-pressed","true"),n.classList.add("like-heart-pressed");const e=n.dataset.id;return setTimeout((()=>{let t=s();var a;t=t.filter((t=>String(t.id)!==String(e))),a=t,localStorage.setItem("likes",JSON.stringify(a||[])),o(),window.dispatchEvent(new CustomEvent("likes:updated",{detail:{likes:t}}))}),180),void t.stopPropagation()}const l=t.target.closest(".like-card");if(l){let t=l.getAttribute("data-id")||l.dataset.id||null;const e=(l.getAttribute("data-source")||l.dataset.source||"").toLowerCase()||null;if(!t)try{const e=s(),a=l.querySelector(".like-title")?.textContent?.trim(),r=l.querySelector(".like-thumb img")?.src,i=e.find((t=>t.title&&t.title===a||t.image&&t.image===r));i&&i.id&&(t=i.id)}catch(t){}if(!t)return void alert("Tidak dapat menemukan id produk untuk kartu ini.");let a="./drsi.html";return"dsri"===e?a="./dsri.html":"bsri"===e?a="./bsri.html":t.startsWith("dsri-")?a="./dsri.html":t.startsWith("drsi-")&&(a="./drsi.html"),void window.location.assign(`${a}?id=${encodeURIComponent(String(t))}`)}})),document.addEventListener("DOMContentLoaded",(()=>{i(),o()})),window.addEventListener("likes:updated",o),document.addEventListener("click",(function(t){const e=t.target.closest&&t.target.closest(".gift-toggle");if(!e)return;const a=function(){try{return JSON.parse(localStorage.getItem("cart")||"[]")}catch(t){return[]}}();if(!a||0===a.length){try{e.animate([{transform:"scale(1)"},{transform:"scale(1.04)"},{transform:"scale(1)"}],{duration:180})}catch(t){}return void alert("Tambahkan dulu minimal 1 item ke Bag sebelum menjadikan pesanan sebagai hadiah üíù")}const r="true"===e.getAttribute("aria-pressed");e.setAttribute("aria-pressed",r?"false":"true");try{e.animate([{transform:"scale(1)"},{transform:"scale(1.06)"},{transform:"scale(1)"}],{duration:180})}catch(t){}const i={type:"gift",createdAt:Date.now()};try{localStorage.setItem("giftConfig_v1",JSON.stringify(i))}catch(t){}window.location.href="gif.html"})),window.flushOrderQueue=d;try{onAuthStateChanged(auth,(t=>{t&&d().catch((t=>console.warn("Bagfr flush error",t)))}))}catch(t){console.warn("Bagfr: onAuthStateChanged not registered",t)}document.addEventListener("click",(async function(t){if(!(t.target.closest&&t.target.closest(".checkout")))return;if(t.preventDefault(),!auth.currentUser){if(!confirm("Kamu belum sign in. Mau checkout sebagai tamu? (Pesanan tetap akan tersimpan di server.) Tekan Cancel untuk Sign In.")){try{localStorage.setItem("checkoutDraft_cart",JSON.stringify(c()))}catch(t){}const e=new URLSearchParams({from:"bag",returnTo:"bagfr.html"});return void(window.location.href="singin.html?"+e.toString())}try{await signInAnonymously(auth),await new Promise((t=>setTimeout(t,200)))}catch(t){return console.error("Anonymous sign-in failed",t),void alert("Tidak dapat melanjutkan sebagai tamu. Silakan sign in terlebih dahulu.")}}const e=function(){const t=c();if(!t.length)return null;let e=0;const a=t.map((t=>{const a=Number(t.unitPrice||t.price||0),r=Number(t.qty||1),i=Number(t.subtotal||a*r||a*r);return e+=i,{id:t.id,title:t.title,qty:r,unitPrice:a,subtotal:i,addons:t.addons||[],image:t.image||t.images&&t.images[0]||""}})),r={id:l(),createdAt:Date.now(),status:"active",paymentStatus:"pending",total:e,items:a};try{const t=JSON.parse(localStorage.getItem("giftConfig_v1")||"null");t&&"gift"===t.type&&(r.isGift=!0,r.gift=t)}catch(t){}return r}();e?(async()=>{const t=auth.currentUser,a=t?.uid||localStorage.getItem("maziUID")||null,r={userId:a||null,userEmail:localStorage.getItem("maziEmail")||"",userName:localStorage.getItem("maziName")||"",id:e.id,createdAt:serverTimestamp(),status:e.status,paymentStatus:e.paymentStatus,total:e.total,items:e.items,meta:e.meta||{},isGift:e.isGift||!1,gift:e.gift||null};let i=!1;if(a)try{const t=await addDoc(collection(db,"orders"),r);console.log("Bagfr: Order tersimpan di Firestore dengan id:",t.id),e.firestoreId=t.id,i=!0}catch(t){console.error("Bagfr: Gagal menyimpan order ke Firestore:",t)}else console.warn("Bagfr: no uid available, will enqueue order locally for later sync.");if(!i){!function(t){try{const e="order_sync_queue",a=localStorage.getItem(e)||"[]",r=JSON.parse(a);r.push(t),localStorage.setItem(e,JSON.stringify(r)),console.log("Bagfr: Order queued locally for sync (queue length):",r.length)}catch(t){console.error("Bagfr: enqueueLocalOrder failed",t)}}(Object.assign({},e,{userId:a||null,userEmail:localStorage.getItem("maziEmail")||"",userName:localStorage.getItem("maziName")||"",queuedAt:Date.now()})),alert("Peringatan: koneksi ke server bermasalah atau belum login. Pesanan disimpan sementara dan akan dikirim ke server saat koneksi pulih / setelah login.")}const n=function(){try{return JSON.parse(localStorage.getItem("orders")||"[]")}catch(t){return[]}}();var s;n.unshift(e),s=n,localStorage.setItem("orders",JSON.stringify(s||[])),localStorage.removeItem("cart");try{localStorage.removeItem("giftConfig_v1")}catch(t){}"function"==typeof window.renderCart&&window.renderCart();const o=`Halo mimin Mazi, tolong cek ongkir untuk pesanan ku dengan ID ${e.id}.`,l=`https://wa.me/628118281416?text=${encodeURIComponent(o)}`;try{window.open(l,"_blank")}catch(t){}window.location.href="./order.html?order="+encodeURIComponent(e.id)})():alert("Keranjang kosong. Tambahkan item dulu sebelum checkout.")}))})();