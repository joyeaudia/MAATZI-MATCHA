// @ts-nocheck
const placeOrderBtn=document.getElementById("placeOrder");placeOrderBtn&&placeOrderBtn.addEventListener("click",(async function(){const e=loadCart();if(!e||!e.length)return void alert("Keranjang kosong â€” tidak ada yang dipesan.");const t=auth.currentUser;if(!t){try{localStorage.setItem("checkoutDraft_cart",JSON.stringify(e))}catch(e){}return alert("Silakan sign in dulu untuk melanjutkan pemesanan."),void(window.location.href="singin.html?from=checkout")}let a=null;try{const e=document.querySelector('select[aria-label="Date"]'),t=document.querySelector('select[aria-label="Month"]'),r=document.querySelector('select[aria-label="Year"]'),n=e?.value||"",o=t?.value||"",i=r?.value||"",l=Number(n),s=Number(i);if(!isNaN(l)&&!isNaN(s)&&o){const e={jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12};let t=Number(o);if(isNaN(t)){t=e[String(o).trim().slice(0,3).toLowerCase()]||NaN}if(!isNaN(t)){const e=new Date(s,t-1,l,9,0,0);isNaN(e.getTime())||(a=e.toISOString())}}}catch(e){console.warn("Gagal parsing jadwal:",e)}const r=document.getElementById("notes")?.value?.trim()||"",n=document.getElementById("recipient")?.value?.trim()||"";let o=0;const i=e.reduce(((e,t)=>{const a=Number(t.unitPrice||t.price||0),r=Math.max(0,Number(t.qty||0));return o+=a*r,e+r}),0),l=document.querySelector(".delivery-item.active")?.dataset.method||"regular";let s=15e3;switch(l){case"nextday":s=2e4;break;case"sameday":s=3e4;break;case"instant":s=5e4;break;case"self":s=5e3;break;default:s=15e3}const d=s*Math.max(1,Math.ceil(i/5)),c=Number(o)+Number(d);let m=null,u=!1;try{m=JSON.parse(localStorage.getItem("giftConfig_v1")||"null"),u=!(!m||"gift"!==m.type)}catch(e){m=null,u=!1}const g={userId:t.uid,userEmail:t.email||localStorage.getItem("maziEmail")||"",userName:t.displayName||localStorage.getItem("maziName")||""},p={id:genOrderId(),createdAt:Date.now(),status:"scheduled",scheduledAt:a,total:c,shippingFee:d,items:e.map((e=>({id:e.id,title:e.title,qty:Number(e.qty||1),unitPrice:Number(e.unitPrice||e.price||0),subtotal:Number(e.subtotal||Number(e.unitPrice||e.price||0)*Number(e.qty||1)),addons:e.addons||[],image:e.image||e.images&&e.images[0]||""}))),meta:{notes:r,recipient:n,deliveryMethod:l},paymentStatus:"pending",isGift:u,gift:u?{message:m.message||"",fromName:m.fromName||"",revealMode:m.revealMode||"reveal",theme:m.theme||null}:null,...g};try{const e={...p,createdAt:serverTimestamp()},t=await addDoc(collection(db,"orders"),e);console.log("Order tersimpan di Firestore dengan id:",t.id),p.firestoreId=t.id}catch(e){console.error("Gagal menyimpan order ke Firestore:",e);try{const e={...p,queuedAt:Date.now()};enqueueLocalOrder(e),alert("Peringatan: koneksi ke server bermasalah. Pesanan disimpan sementara dan akan dikirim ke server saat koneksi pulih.")}catch(e){console.error("Failed to enqueue order after firestore write error",e)}}const h=loadOrders();h.unshift(p),saveOrders(h);try{localStorage.removeItem("cart")}catch(e){}try{localStorage.removeItem("giftConfig_v1")}catch(e){}try{const e="628118281416",t=p.scheduledAt?new Date(p.scheduledAt).toLocaleString("id-ID"):"(tanpa jadwal)";let a="";a=u?`Halo mimin Mazi, ini pesanan GIFT terjadwal dengan ID ${p.id}. Mohon dibantu proses untuk jadwal ${t}.`:`Halo mimin Mazi, tolong proses pesanan terjadwal saya dengan ID ${p.id}.`;const r=`https://wa.me/${e}?text=${encodeURIComponent(a)}`,n=document.getElementById("ddno-overlay"),o=document.getElementById("ddno-logo");n&&n.classList.add("show"),o&&(o.classList.remove("show"),setTimeout((()=>o.classList.add("show")),50)),setTimeout((()=>{try{window.open(r,"_blank")}catch(e){console.warn("Failed to open WhatsApp",e)}window.location.href="./order.html?order="+encodeURIComponent(p.id)}),1500)}catch(e){console.warn("Failed to prepare WhatsApp redirect",e),window.location.href="./order.html?order="+encodeURIComponent(p.id)}}));