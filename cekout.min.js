// @ts-nocheck
import{db,auth}from"./firebase-config.js";window._auth_for_debug=auth;import{onAuthStateChanged}from"https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";import{collection,addDoc,serverTimestamp}from"https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";document.addEventListener("DOMContentLoaded",(function(){"use strict";const e=e=>{const t=Math.round(Number(e)||0),a=Math.abs(t).toString(),r=[];for(let e=a.length-1,t=0;e>=0;e--,t++)r.push(a[e]),t%3==2&&0!==e&&r.push(".");return(t<0?"-":"")+"Rp "+r.reverse().join("")+",00"};function t(e){try{return JSON.parse(localStorage.getItem(e)||"[]")}catch(e){return[]}}function a(e,t){localStorage.setItem(e,JSON.stringify(t||[]))}function r(){return t("cart")}async function n(){try{const e="order_sync_queue",t=localStorage.getItem(e)||"[]",a=JSON.parse(t);if(!Array.isArray(a)||0===a.length)return;const r=auth.currentUser;if(!r)return void console.warn("flushOrderQueue: no authenticated user — skip flush until login.");console.log("Flushing order sync queue, items:",a.length);for(let e=0;e<a.length;e++){const t=a[e];try{const n={userId:r.uid,userEmail:r.email||localStorage.getItem("maziEmail")||"",userName:localStorage.getItem("maziName")||"",...t,createdAt:serverTimestamp()},o=await addDoc(collection(db,"orders"),n);console.log("Flushed order -> firestore id:",o.id,"local order id:",t.id),a.splice(e,1),e--}catch(e){console.warn("flushOrderQueue: failed to push one order, will retry later",e);break}}localStorage.setItem(e,JSON.stringify(a))}catch(e){console.error("flushOrderQueue failed",e)}}function o(e){return String(e||"").replace(/[&<>"']/g,(function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e]}))}window.flushOrderQueue=n;const i=document.querySelector(".product-list"),c=document.getElementById("subtotalRp"),l=document.getElementById("shippingFee"),s=document.getElementById("totalRp"),u=Array.from(document.querySelectorAll(".delivery-item")),d=(document.getElementById("deliveryRow"),document.getElementById("btnUseSavedAddress"));d&&d.addEventListener("click",(function(){window.location.href="drafamt.html?from=checkout"}));const m=document.getElementById("recipient");try{const e=localStorage.getItem("checkoutRecipientDraft_v1");m&&e&&(m.value=e,localStorage.removeItem("checkoutRecipientDraft_v1"))}catch(e){}if(!(i&&c&&l&&s))return void console.warn("cekout: required elements not found");function g(){const t=r();if(i.innerHTML="",!t||!t.length){const e=document.createElement("li");return e.className="product-item",e.innerHTML='<div class="product-info"><div class="product-title">Keranjang kosong</div><div class="product-meta muted">Tambahkan produk dari keranjang</div></div>',i.appendChild(e),void p()}t.forEach(((t,a)=>{const r=Number(t.unitPrice||t.price||0),n=Math.max(0,Number(t.qty||1)),c=document.createElement("li");c.className="product-item",c.dataset.cartIdx=a;const l=t.source?`${t.source} • `:"",s=e(r);c.innerHTML=`\n        <div class="product-info">\n          <div class="product-title">${o(t.title||"Untitled")}</div>\n          <div class="product-meta">${o(l)}${s}</div>\n        </div>\n        <div class="qty-control" data-price="${r}">\n          <button class="qty-btn dec" aria-label="Decrease">−</button>\n          <input class="qty-input" type="text" inputmode="numeric" value="${n}" aria-label="Quantity">\n          <button class="qty-btn inc" aria-label="Increase">+</button>\n        </div>\n      `,i.appendChild(c);const u=c.querySelector(".dec"),d=c.querySelector(".inc"),m=c.querySelector(".qty-input");u.addEventListener("click",(()=>{let e=Number(m.value)||0;e=Math.max(0,e-1),m.value=String(e),h(a,e)})),d.addEventListener("click",(()=>{let e=Number(m.value)||0;e+=1,m.value=String(e),h(a,e)})),m.addEventListener("input",(()=>{m.value=m.value.replace(/[^\d]/g,""),""===m.value&&(m.value="0");const e=Number(m.value);h(a,e)}))}))}function h(e,t){const n=r();n&&n[e]?(n[e].qty=Number(t||0),n[e].subtotal=Number(Number(n[e].unitPrice||n[e].price||0)*Number(n[e].qty||0)),n[e].qty<=0&&n.splice(e,1),function(e){a("cart",e)}(n),g(),p()):p()}function p(){const t=r();let a=0,n=0;Array.isArray(t)&&t.forEach((e=>{const t=Number(e.unitPrice||e.price||0),r=Math.max(0,Number(e.qty||0));n+=t*r,a+=r}));let o=15e3;switch(document.querySelector(".delivery-item.active")?.dataset.method||"regular"){case"regular":default:o=15e3;break;case"nextday":o=2e4;break;case"sameday":o=3e4;break;case"instant":o=5e4;break;case"self":o=5e3}const i=o*(a>0?Math.max(1,Math.ceil(a/5)):1),u=n+i;c&&(c.textContent=e(n)),l&&(l.textContent=e(i)),s&&(s.textContent=e(u))}u.forEach((e=>{e.addEventListener("click",(()=>{u.forEach((e=>{e.classList.remove("active"),e.setAttribute("aria-pressed","false")})),e.classList.add("active"),e.setAttribute("aria-pressed","true"),"function"==typeof e.scrollIntoView&&e.scrollIntoView({behavior:"smooth",inline:"center",block:"nearest"}),p()}))}));const f=document.getElementById("placeOrder");f&&f.addEventListener("click",(async function(){const e=r();if(!e||!e.length)return void alert("Keranjang kosong — tidak ada yang dipesan.");if(!auth.currentUser){try{localStorage.setItem("checkoutDraft_cart",JSON.stringify(e))}catch(e){}return alert("Silakan sign in dulu untuk melanjutkan pemesanan."),void(window.location.href="singin.html?from=checkout")}let n=null;try{const e=document.querySelector('select[aria-label="Date"]'),t=document.querySelector('select[aria-label="Month"]'),a=document.querySelector('select[aria-label="Year"]'),r=e?.value||"",o=t?.value||"",i=a?.value||"",c=Number(r),l=Number(i);if(!isNaN(c)&&!isNaN(l)&&o){const e={jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12};let t=Number(o);if(isNaN(t)){t=e[String(o).trim().slice(0,3).toLowerCase()]||NaN}if(!isNaN(t)){const e=new Date(l,t-1,c,9,0,0);isNaN(e.getTime())||(n=e.toISOString())}}}catch(e){}const o=document.getElementById("notes")?.value?.trim()||"",i=document.getElementById("recipient")?.value?.trim()||"";let c=0;e.forEach((e=>{c+=Number(e.subtotal||Number(e.unitPrice||e.price||0)*Number(e.qty||0)||0)}));const l=document.querySelector(".delivery-item.active")?.dataset.method||"regular";let s=15e3;switch(l){case"regular":default:s=15e3;break;case"nextday":s=2e4;break;case"sameday":s=3e4;break;case"instant":s=5e4;break;case"self":s=5e3}const u=e.reduce(((e,t)=>e+Number(t.qty||0)),0),d=s*Math.max(1,Math.ceil(u/5)),m=Number(c)+Number(d);let g=null;try{g=JSON.parse(localStorage.getItem("giftConfig_v1")||"null")}catch(e){g=null}const h=!(!g||"gift"!==g.type),p={id:"ORD-"+(new Date).toISOString().slice(0,10)+"-"+Math.random().toString(36).slice(2,6).toUpperCase(),createdAt:Date.now(),status:"scheduled",scheduledAt:n,total:m,shippingFee:d,items:e.map((e=>({id:e.id,title:e.title,qty:Number(e.qty||1),unitPrice:Number(e.unitPrice||e.price||0),subtotal:Number(e.subtotal||Number(e.unitPrice||e.price||0)*Number(e.qty||1)),addons:e.addons||[],image:e.image||e.images&&e.images[0]||""}))),meta:{notes:o,recipient:i,deliveryMethod:l},paymentStatus:"pending"};h&&(p.isGift=!0,p.gift={message:g.message||"",fromName:g.fromName||"",revealMode:g.revealMode||"reveal",theme:g.theme||null});const f=localStorage.getItem("maziUID")||null,y=localStorage.getItem("maziEmail")||"",v=localStorage.getItem("maziName")||"";try{const e={userId:f,userEmail:y,userName:v,...p,createdAt:serverTimestamp()},t=await addDoc(collection(db,"orders"),e);console.log("Order tersimpan di Firestore dengan id:",t.id),p.firestoreId=t.id}catch(e){console.error("Gagal menyimpan order ke Firestore:",e);try{!function(e){try{const t="order_sync_queue",a=localStorage.getItem(t)||"[]",r=JSON.parse(a);r.push(e),localStorage.setItem(t,JSON.stringify(r)),console.log("Order queued locally for sync (queue length):",r.length)}catch(e){console.error("enqueueLocalOrder failed",e)}}(Object.assign({},p,{userId:f,userEmail:y,userName:v,queuedAt:Date.now()})),alert("Peringatan: koneksi ke server bermasalah. Pesanan disimpan sementara dan akan dikirim ke server saat koneksi pulih.")}catch(e){console.error("Failed to enqueue order after firestore write error",e)}}const b=t("orders");b.unshift(p),a("orders",b);try{localStorage.removeItem("cart")}catch(e){}try{localStorage.removeItem("giftConfig_v1")}catch(e){}try{const e="628118281416";let t="";if(h){const e=n?new Date(n).toLocaleString("id-ID"):"(tanpa jadwal)";t=`Halo mimin Mazi, ini pesanan GIFT terjadwal dengan ID ${p.id}. Mohon dibantu proses untuk jadwal ${e}.`}else t=`Halo mimin Mazi, tolong proses pesanan terjadwal saya dengan ID ${p.id}.`;const a=`https://wa.me/${e}?text=${encodeURIComponent(t)}`,r=document.getElementById("ddno-overlay"),o=document.getElementById("ddno-logo");r&&r.classList.add("show"),o&&(o.classList.remove("show"),setTimeout((()=>{o.classList.add("show")}),50)),setTimeout((()=>{try{window.open(a,"_blank")}catch(e){console.warn("Failed to open WhatsApp",e)}window.location.href="./order.html?order="+encodeURIComponent(p.id)}),1500)}catch(e){console.warn("Failed to prepare WhatsApp redirect",e),window.location.href="./order.html?order="+encodeURIComponent(p.id)}}));try{"function"==typeof onAuthStateChanged?onAuthStateChanged(auth,(e=>{e?(console.log("onAuthStateChanged: user logged in — attempting to flush order queue"),n().catch((e=>console.warn("flushOrderQueue error",e)))):console.log("onAuthStateChanged: no user — not flushing order queue")})):console.warn("onAuthStateChanged is not a function — did you import it?")}catch(e){console.warn("Failed to register auth listener",e)}!function({yearsAhead:e=5}={}){const t=document.querySelector('select[aria-label="Date"]'),a=document.querySelector('select[aria-label="Month"]'),r=document.querySelector('select[aria-label="Year"]');if(!t||!a||!r)return;function n(e,t){const a=document.createElement("option");return a.value=String(e),a.textContent=String(t),a}t.innerHTML="",a.innerHTML="",r.innerHTML="",a.appendChild(n("","Month")),["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"].forEach(((e,t)=>a.appendChild(n(t+1,e))));const o=new Date,i=o.getFullYear();r.appendChild(n("","Year"));for(let t=i;t<=i+(Number(e)||5);t++)r.appendChild(n(t,t));function c(){const e=Number(a.value)||o.getMonth()+1,c=Number(r.value)||i,l=function(e,t){return new Date(e,t+1,0).getDate()}(c,e-1),s=Number(t.value)||o.getDate();t.innerHTML="",t.appendChild(n("","Date"));for(let e=1;e<=l;e++)t.appendChild(n(e,e));s>=1&&s<=l?t.value=String(s):c===i&&e===o.getMonth()+1?t.value=String(o.getDate()):t.value="1"}a.value=String(o.getMonth()+1),r.value=String(i),c(),a.addEventListener("change",c),r.addEventListener("change",c)}({yearsAhead:5}),g(),p()}));